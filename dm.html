<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DM — ScrimSNS</title>
  <link rel="stylesheet" href="css/style.css" />
  <style>
    body { font-family: sans-serif; margin:0; padding:0; background:#f0f2f5; }
    header { background:#1d9bf0; color:#fff; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; }
    header h1 { font-size:1.2rem; margin:0; }
    header nav a { color:#fff; margin-left:12px; text-decoration:none; }
    main { display:flex; flex-direction:column; height:calc(100vh - 56px); padding:12px; box-sizing:border-box; }

    .chat-header { font-weight:bold; margin-bottom:8px; }
    .chat-messages { flex:1; overflow-y:auto; padding:12px; display:flex; flex-direction:column; gap:8px; background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-bottom:12px; }
    .msg { max-width:78%; padding:10px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); word-break:break-word; }
    .msg.you { align-self:flex-end; background:linear-gradient(180deg, #1d9bf0,#1673c8); color:#fff; }
    .msg.other { align-self:flex-start; background:#f1f3f5; color:#333; }
    .chat-meta { font-size:0.75rem; color:#666; margin-top:4px; }
    .chat-input { display:flex; gap:8px; }
    .chat-input input { flex:1; padding:8px 12px; border-radius:8px; border:1px solid #ccc; }
    .chat-input button { padding:8px 12px; border-radius:8px; background:#1d9bf0; color:#fff; border:none; cursor:pointer; }
    .chat-input button:disabled { background:#aaa; cursor:not-allowed; }
  </style>
</head>
<body>
  <header>
    <h1>ScrimSNS — DM</h1>
    <nav>
      <a href="index.html">🏠 ホーム</a>
      <a href="profile.html">👤 プロフィール</a>
    </nav>
  </header>

  <main>
    <div class="chat-header" id="chatHeader">読み込み中...</div>
    <div id="messages" class="chat-messages">
      <p>読み込み中…</p>
    </div>
    <div class="chat-input">
      <input id="msgInput" placeholder="メッセージを入力" />
      <button id="sendBtn" disabled>送信</button>
    </div>
  </main>

  <script type="module">
    import { auth, db } from "https://jpgya.github.io/scrimtool/js/firebase.js";
    import { collection, doc, getDoc, setDoc, addDoc, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const chatHeader = document.getElementById("chatHeader");

    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get("chat");

    auth.onAuthStateChanged(async user => {
      if (!user) {
        alert("ログインしてください");
        window.location.href = "login.html";
        return;
      }
      const myUid = user.uid;

      if (!postId) {
        messagesDiv.innerHTML = "<p>無効な投稿IDです</p>";
        return;
      }

      try {
        // 投稿情報を取得
        const postDoc = await getDoc(doc(db, "scrims", postId));
        if (!postDoc.exists()) {
          messagesDiv.innerHTML = "<p>投稿が存在しません</p>";
          return;
        }

        const postData = postDoc.data();
        const chatId = postId; // 投稿IDをチャットIDにする
        const targetUid = postData.userUid;
        const targetName = postData.userName || "不明";

        chatHeader.textContent = `DM: ${targetName}`;

        // チャットが存在するか確認、なければ作成
        const chatRef = doc(db, "chats", chatId);
        const chatSnap = await getDoc(chatRef);
        if (!chatSnap.exists()) {
          await setDoc(chatRef, {
            postId: chatId,
            user1: myUid,
            user2: targetUid,
            createdAt: new Date()
          });
        }

        // メッセージの読み込み
        const messagesRef = collection(db, "chats", chatId, "messages");
        const q = query(messagesRef, orderBy("createdAt", "asc"));
        onSnapshot(q, snapshot => {
          messagesDiv.innerHTML = "";
          if (snapshot.empty) {
            messagesDiv.innerHTML = "<p>まだメッセージはありません。送信してみましょう。</p>";
            return;
          }
          snapshot.forEach(doc => {
            const data = doc.data();
            const msgEl = document.createElement("div");
            msgEl.classList.add("msg", data.fromUid === myUid ? "you" : "other");
            const time = data.createdAt ? new Date(data.createdAt.seconds ? data.createdAt.seconds * 1000 : data.createdAt).toLocaleString() : "";
            msgEl.innerHTML = `
              <p><strong>${data.fromName || data.fromUid}</strong></p>
              <p>${data.text}</p>
              <p class="chat-meta">${time}</p>
            `;
            messagesDiv.appendChild(msgEl);
          });
          messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        // 送信ボタン有効化
        sendBtn.disabled = false;
        sendBtn.onclick = async () => {
          const text = msgInput.value.trim();
          if (!text) return;

          await addDoc(messagesRef, {
            fromUid: myUid,
            fromName: auth.currentUser.displayName || "名無し",
            toUid: targetUid,
            toName: targetName,
            text,
            createdAt: new Date()
          });
          msgInput.value = "";
        };

      } catch (err) {
        console.error(err);
        messagesDiv.innerHTML = "<p>チャットの読み込みに失敗しました</p>";
        sendBtn.disabled = true;
      }
    });
  </script>
</body>
</html>
